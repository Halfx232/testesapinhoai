// 1. Configurações Globais e Seleção de Elementos
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    
    // Sons
    const jumpSound = document.getElementById("jumpSound");
    const failSound = document.getElementById("failSound");
    const victorySound = document.getElementById("victorySound");
    const backgroundMusic = document.getElementById("backgroundMusic");

    // Banners e Botões
    const startBanner = document.getElementById("start-banner");
    const gameOverBanner = document.getElementById("game-over-banner");
    const finalScore = document.getElementById("final-score");
    const restartButton = document.getElementById("restart-button");
    const victoryBanner = document.getElementById("victory-banner");
    const victoryScore = document.getElementById("victory-score");
    const playAgainButton = document.getElementById("play-again-button");

    // Constantes do Jogo
    const PONTUACAO_VITORIA = 5000;
    const GRAVIDADE = 1.5;
    const BASE_WIDTH = 800;
    const BASE_HEIGHT = 400;
    const ALTURA_SAPO = 40;
    const ESPESSURA_CHAO = isMobile ? 20 : 50;
    const SAPO_OFFSET_VISUAL = 47;
    const fases = ["primavera", "verão", "outono", "inverno"];
    const coresFase = {
      primavera: { fundo: "#dcedc8", chao: "#81c784" },
      verão: { fundo: "#fff9c4", chao: "#fbc02d" },
      outono: { fundo: "#ffe0b2", chao: "#ff8f00" },
      inverno: { fundo: "#e0f7fa", chao: "#4dd0e1" }
    };

    // Variáveis de Estado
    let gameStarted = false;
    let sapo, obstaculos = [], tempo, intervaloObstaculo, faseAtual, pontuacao;
    let poeira = [], animationFrameId, scaleX = 1, scaleY = 1, ALTURA_CHAO;

    // --- FUNÇÕES DE LÓGICA DO JOGO ---

    function positionBanners() {
      const banners = [startBanner, gameOverBanner, victoryBanner];
      const canvasRect = canvas.getBoundingClientRect();
      const gameContainer = document.getElementById('game-container');

      banners.forEach(banner => {
        if (banner.classList.contains('active')) {
          banner.style.position = 'absolute';
          const canvasCenterX = canvasRect.left - gameContainer.getBoundingClientRect().left + canvasRect.width / 2;
          const canvasCenterY = canvasRect.top - gameContainer.getBoundingClientRect().top + canvasRect.height / 2;
          banner.style.left = `${canvasCenterX}px`;
          banner.style.top = `${canvasCenterY}px`;
          banner.style.transform = 'translate(-50%, -50%)';
          banner.style.zIndex = '1000';
        }
      });
    }

    function resizeCanvas() {
      if (isMobile) {
        const maxWidth = Math.min(window.innerWidth - 20, 400);
        canvas.width = maxWidth;
        canvas.height = maxWidth / 2;
        scaleX = canvas.width / BASE_WIDTH;
        scaleY = canvas.height / BASE_HEIGHT;
      } else {
        canvas.width = BASE_WIDTH;
        canvas.height = BASE_HEIGHT;
        scaleX = 1; scaleY = 1;
      }
      ALTURA_CHAO = canvas.height;
      if (sapo) {
        sapo.x = BASE_WIDTH * 0.2 * scaleX;
        sapo.y = ALTURA_CHAO - ESPESSURA_CHAO - SAPO_OFFSET_VISUAL * scaleY;
      }
      positionBanners();
    }

    const startGameHandler = (e) => {
      if (e) e.preventDefault();
      
      // DESBLOQUEIO DE ÁUDIO (iOS/Android)
      const sons = [backgroundMusic, jumpSound, failSound, victorySound];
      sons.forEach(s => {
          s.play().then(() => { s.pause(); s.currentTime = 0; }).catch(() => {});
      });

      if (!gameStarted && startBanner.classList.contains('active')) {
          startBanner.classList.remove('active');
          iniciarJogo();
      }
    };

    function resetGame() {
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      
      sapo = { x: BASE_WIDTH * 0.2 * scaleX, y: 0, width: 40 * scaleX, height: ALTURA_SAPO * scaleY, vy: 0, jumping: false };
      obstaculos = []; poeira = []; tempo = 0; intervaloObstaculo = 120; faseAtual = 0; pontuacao = 0;
      
      gameOverBanner.classList.remove('active');
      victoryBanner.classList.remove('active');
      startBanner.classList.add('active');
      gameStarted = false;

      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;

      // Eventos de Início
      startBanner.addEventListener('click', startGameHandler);
      startBanner.addEventListener('touchstart', startGameHandler, {passive: false});
      document.addEventListener('keydown', (e) => { if(!gameStarted) startGameHandler(e); });

      resizeCanvas();
    }

    function handleJump() {
      if (gameStarted && !sapo.jumping) {
        sapo.vy = -20 * scaleY;
        sapo.jumping = true;
        jumpSound.currentTime = 0;
        jumpSound.play().catch(() => {});
        // Efeito de poeira
        for (let i = 0; i < 8; i++) {
          poeira.push({
            x: sapo.x + 20 * scaleX, y: sapo.y + 35 * scaleY,
            raio: (3 + Math.random() * 4) * scaleX, alpha: 0.7,
            vy: -Math.random() * 2, vx: Math.random() * 2 - 1
          });
        }
      }
    }

    function iniciarJogo() {
      gameStarted = true;
      backgroundMusic.play().catch(() => {});
      
      // Atalhos de pulo
      document.addEventListener('keydown', (e) => {
        if ((e.code === 'Space' || e.code === 'ArrowUp')) handleJump();
      });
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleJump();
      }, {passive: false});

      animationFrameId = requestAnimationFrame(gameLoop);
    }

    // --- LOOP E DESENHO ---

    function gameLoop() {
      if (!gameStarted) return;
      
      const fase = fases[faseAtual % fases.length];
      canvas.style.background = coresFase[fase].fundo;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Chão
      ctx.fillStyle = coresFase[fase].chao;
      ctx.fillRect(0, ALTURA_CHAO - ESPESSURA_CHAO, canvas.width, ESPESSURA_CHAO);

      // Gravidade Sapo
      sapo.vy += GRAVIDADE * scaleY;
      sapo.y += sapo.vy;
      const chaoY = ALTURA_CHAO - ESPESSURA_CHAO - SAPO_OFFSET_VISUAL * scaleY;
      if (sapo.y > chaoY) {
        sapo.y = chaoY;
        sapo.vy = 0;
        sapo.jumping = false;
      }

      // Desenhar Sapo (Simplificado para performance)
      ctx.save();
      ctx.fillStyle = "green";
      ctx.beginPath();
      ctx.ellipse(sapo.x + 20*scaleX, sapo.y + 20*scaleY, 20*scaleX, 15*scaleY, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      // Obstáculos e Colisão
      if (tempo % intervaloObstaculo === 0 && tempo >= 60) {
        obstaculos.push({ x: canvas.width, y: ALTURA_CHAO - ESPESSURA_CHAO - 30*scaleY, width: 30*scaleX, height: 30*scaleY });
      }
      
      obstaculos.forEach((obs, index) => {
        obs.x -= 5 * scaleX;
        ctx.fillStyle = "#d32f2f";
        ctx.fillRect(obs.x, obs.y, obs.width, obs.height);

        // Colisão simplificada
        if (sapo.x < obs.x + obs.width && sapo.x + 30*scaleX > obs.x &&
            sapo.y + 10*scaleY < obs.y + obs.height && sapo.y + 40*scaleY > obs.y) {
          finalizarJogo(false);
        }
      });

      obstaculos = obstaculos.filter(obs => obs.x + obs.width > 0);
      
      // Poeira
      poeira.forEach((p, i) => {
        ctx.fillStyle = `rgba(100, 100, 100, ${p.alpha})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.raio, 0, Math.PI*2); ctx.fill();
        p.alpha -= 0.02; p.raio -= 0.05;
      });
      poeira = poeira.filter(p => p.alpha > 0);

      tempo++;
      pontuacao++;
      if (tempo % 1000 === 0) {
        faseAtual++;
        intervaloObstaculo = Math.max(60, intervaloObstaculo - 5);
      }
      if (pontuacao >= PONTUACAO_VITORIA) finalizarJogo(true);

      ctx.fillStyle = "#000";
      ctx.font = "bold 16px Arial";
      ctx.fillText(`Score: ${pontuacao}`, 10, 25);

      animationFrameId = requestAnimationFrame(gameLoop);
    }

    function finalizarJogo(vitoria) {
      gameStarted = false;
      cancelAnimationFrame(animationFrameId);
      backgroundMusic.pause();
      
      if (vitoria) {
        victorySound.play().catch(() => {});
        victoryScore.textContent = pontuacao;
        victoryBanner.classList.add('active');
      } else {
        failSound.play().catch(() => {});
        finalScore.textContent = pontuacao;
        gameOverBanner.classList.add('active');
      }
      positionBanners();
    }

    // --- UTILITÁRIOS E INICIALIZAÇÃO EXTERNA ---

    function debounce(func, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    async function fetchWeather() {
      try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Sao%20Paulo&appid=b8a0cd03c689322da2746720be31d534&lang=pt_br&units=metric`);
        const data = await res.json();
        document.getElementById("weather").textContent = ` SP: ${Math.round(data.main.temp)}°C, ${data.weather[0].description}`;
      } catch (e) { document.getElementById("weather").textContent = "Clima indisponível"; }
    }

    function atualizarHora() {
      const now = new Date();
      document.getElementById("clock").textContent = ` ${now.toLocaleDateString('pt-BR')} - ${now.toLocaleTimeString('pt-BR')}`;
    }

    // Inicialização Final
    window.addEventListener('load', () => {
      resetGame();
      fetchWeather();
      atualizarHora();
      setInterval(fetchWeather, 600000);
      setInterval(atualizarHora, 1000);
      
      window.addEventListener('resize', debounce(resizeCanvas, 100));
      restartButton.addEventListener("click", resetGame);
      playAgainButton.addEventListener("click", resetGame);
      
      // Menu mobile
      const menuToggle = document.getElementById('menu-toggle');
      const navMenu = document.getElementById('nav-menu');
      if (menuToggle) menuToggle.addEventListener('click', () => navMenu.classList.toggle('open'));
    });
